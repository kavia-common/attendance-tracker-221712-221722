{"is_source_file": true, "format": "Python", "description": "This file contains database utility functions, connection pooling management, schema setup, and server-sent events (SSE) broker implementations for the attendance tracker project, specifically for the firebase_functions.app module.", "external_files": ["psycopg2", "psycopg2.pool", "os", "threading", "time", "contextlib"], "external_methods": ["psycopg2.connect", "psycopg2.pool.SimpleConnectionPool", "threading.Lock", "threading.Condition"], "published": ["execute_query", "execute_many", "ensure_schema", "get_db_connection"], "classes": [{"name": "SingletonConnectionPool", "description": "A thread-safe singleton wrapper around psycopg2's connection pool to manage database connections efficiently."}, {"name": "SseBroker", "description": "A lightweight in-memory broker for broadcasting Server-Sent Events (SSE) to connected clients within a single process."}, {"name": "SseClient", "description": "Represents a single SSE client, providing methods to send events and stream data."}], "methods": [{"name": "\"SingletonConnectionPool\" instance(cls)", "description": "Returns the singleton instance of SingletonConnectionPool, initializing it if necessary.", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"name": "getconn(self)", "description": "Retrieves a connection from the pool.", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"name": "putconn(self, conn)", "description": "Returns a connection back to the pool.", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"name": "closeall(self)", "description": "Closes all connections in the pool.", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"name": "get_db_connection()", "description": "Context manager that provides a pooled database connection, ensuring proper release after use.", "scope": "", "scopeKind": ""}, {"name": "_execute(cur, query: str, params: Optional[Iterable[Any]] = None)", "description": "Executes a SQL statement with optional parameters using a cursor.", "scope": "", "scopeKind": ""}, {"name": "Tuple[List[Tuple],Optional[List[str]]] execute_query( query: str, params: Optional[Iterable[Any]] = None, fetch: str = \"all\" )", "description": "Executes a SQL query with parameters, returning fetched rows and column names based on the fetch mode.", "scope": "", "scopeKind": ""}, {"name": "int execute_many(query: str, seq_of_params: Iterable[Iterable[Any]])", "description": "Executes multiple statements efficiently using executemany.", "scope": "", "scopeKind": ""}, {"name": "None ensure_schema()", "description": "Creates required tables and indexes for the application if they do not already exist.", "scope": "", "scopeKind": ""}, {"name": "None __init__(self)", "scope": "SseClient", "scopeKind": "class", "description": "unavailable"}, {"name": "None publish(self, event: str, data: Dict[str, Any])", "scope": "SseBroker", "scopeKind": "class", "description": "unavailable"}, {"name": "int register(self, client: \"SseClient\")", "scope": "SseBroker", "scopeKind": "class", "description": "unavailable"}, {"name": "None send(self, event: str, data: Dict[str, Any])", "scope": "SseClient", "scopeKind": "class", "description": "unavailable"}, {"name": "stream(self)", "scope": "SseClient", "scopeKind": "class", "description": "unavailable"}, {"name": "None unregister(self, client_id: int)", "scope": "SseBroker", "scopeKind": "class", "description": "unavailable"}], "calls": ["psycopg2.connect", "psycopg2.pool.SimpleConnectionPool", "threading.Lock", "threading.Condition", "get_db_connection", "_execute", "cur.execute", "conn.commit", "cur.fetchall", "cur.fetchone", "desc for desc in cur.description", "cur.executemany"], "search-terms": ["SingletonConnectionPool", "psycopg2 connection pool", "schema setup", "SSE broker", "database connection management", "attendance schemas"], "state": 2, "file_id": 7, "knowledge_revision": 15, "git_revision": "", "ctags": [{"_type": "tag", "name": "SingletonConnectionPool", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^class SingletonConnectionPool:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "SseBroker", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^class SseBroker:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "SseClient", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^class SseClient:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def __init__(self) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self)", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def __init__(self) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self)", "scope": "SseBroker", "scopeKind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def __init__(self) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self)", "scope": "SseClient", "scopeKind": "class"}, {"_type": "tag", "name": "_execute", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^def _execute(cur, query: str, params: Optional[Iterable[Any]] = None):$/", "language": "Python", "kind": "function", "signature": "(cur, query: str, params: Optional[Iterable[Any]] = None)"}, {"_type": "tag", "name": "_instance", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    _instance: Optional[\"SingletonConnectionPool\"] = None$/", "language": "Python", "typeref": "typename:Optional[\"SingletonConnectionPool\"]", "kind": "variable", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "_instance_lock", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    _instance_lock = threading.Lock()$/", "language": "Python", "kind": "variable", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "closeall", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def closeall(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "ensure_schema", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^def ensure_schema() -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "execute_many", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^def execute_many(query: str, seq_of_params: Iterable[Iterable[Any]]) -> int:$/", "language": "Python", "typeref": "typename:int", "kind": "function", "signature": "(query: str, seq_of_params: Iterable[Iterable[Any]])"}, {"_type": "tag", "name": "execute_query", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^def execute_query($/", "language": "Python", "typeref": "typename:Tuple[List[Tuple],Optional[List[str]]]", "kind": "function", "signature": "( query: str, params: Optional[Iterable[Any]] = None, fetch: str = \"all\" )"}, {"_type": "tag", "name": "get_db_connection", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^def get_db_connection():$/", "language": "Python", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "getconn", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def getconn(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "instance", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def instance(cls) -> \"SingletonConnectionPool\":$/", "language": "Python", "typeref": "typename:\"SingletonConnectionPool\"", "kind": "member", "signature": "(cls)", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "publish", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def publish(self, event: str, data: Dict[str, Any]) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, event: str, data: Dict[str, Any])", "scope": "SseBroker", "scopeKind": "class"}, {"_type": "tag", "name": "putconn", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def putconn(self, conn):$/", "language": "Python", "kind": "member", "signature": "(self, conn)", "scope": "SingletonConnectionPool", "scopeKind": "class"}, {"_type": "tag", "name": "register", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def register(self, client: \"SseClient\") -> int:$/", "language": "Python", "typeref": "typename:int", "kind": "member", "signature": "(self, client: \"SseClient\")", "scope": "SseBroker", "scopeKind": "class"}, {"_type": "tag", "name": "send", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def send(self, event: str, data: Dict[str, Any]) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, event: str, data: Dict[str, Any])", "scope": "SseClient", "scopeKind": "class"}, {"_type": "tag", "name": "sse_broker", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^sse_broker = SseBroker()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "stream", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def stream(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "SseClient", "scopeKind": "class"}, {"_type": "tag", "name": "unregister", "path": "/home/kavia/workspace/code-generation/attendance-tracker-221712-221722/firebase_functions/app/db.py", "pattern": "/^    def unregister(self, client_id: int) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, client_id: int)", "scope": "SseBroker", "scopeKind": "class"}], "hash": "e0327831e77a14dd0265c1bfd0212ced", "format-version": 4, "code-base-name": "firebase_functions", "filename": "firebase_functions/app/db.py", "fields": [{"name": "Optional[\"SingletonConnectionPool\"] _instance", "scope": "SingletonConnectionPool", "scopeKind": "class", "description": "unavailable"}, {"name": "_instance_lock = threading.Lock()", "scope": "SingletonConnectionPool", "scopeKind": "class", "description": "unavailable"}, {"name": "sse_broker = SseBroker()", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"15": ""}]}